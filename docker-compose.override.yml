services:
  # mount code & enable OpenLineage on all Airflow services that run tasks
  airflow-apiserver:
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
      # Do NOT install heavy dependencies on the API server; only serves the UI/API
      PIP_CONSTRAINT: "https://raw.githubusercontent.com/apache/airflow/constraints-3.1.2/constraints-3.11.txt"
      AIRFLOW__CORE__AUTH_MANAGER: "airflow.api_fastapi.auth.managers.simple.simple_auth_manager.SimpleAuthManager"
      _PIP_ADDITIONAL_REQUIREMENTS: "-r /opt/airflow/requirements.txt"

    command: api-server
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-scheduler:
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
      # Runtime pip installs disabled; dependencies baked into image
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-worker:
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
      # Runtime pip installs disabled; dependencies baked into image
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-dag-processor:
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
      _PIP_ADDITIONAL_REQUIREMENTS: "-r /opt/airflow/requirements.txt"

      # No extra requirements needed on dag-processor; avoids restart loop when file not mounted
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-triggerer:
    environment:
      # Runtime pip installs disabled; dependencies baked into image
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  # Lineage backend + UI
  marquez:
    image: marquezproject/marquez:latest
    ports: ["5050:5000","5051:5001"]
  marquez-web:
    image: marquezproject/marquez-web:latest
    environment: { MARQUEZ_HOST: marquez, MARQUEZ_PORT: "5000" }
    ports: ["3000:3000"]
