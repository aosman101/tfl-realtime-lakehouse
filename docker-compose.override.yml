services:
  # mount code & enable OpenLineage on all Airflow services that run tasks
  airflow-apiserver:
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-scheduler:
    environment:
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-worker:
    environment:
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  # Lineage backend + UI
  marquez:
    image: marquezproject/marquez:latest
    # Port 5000 on the host conflicts with macOS ControlCenter which listens on 5000.
    # Use a different host port to avoid bind errors (host:container).
    ports: ["5002:5000","5001:5001"]
  marquez-web:
    image: marquezproject/marquez-web:latest
    environment: { MARQUEZ_HOST: marquez, MARQUEZ_PORT: "5000" }
    ports: ["3000:3000"]

  # Override healthchecks for some Airflow services to allow more time
  # (the default healthcheck timeout is 10s and can cause transient failures on slower machines)
  airflow-dag-processor:
    healthcheck:
      test: ["CMD-SHELL", 'airflow jobs check --job-type DagProcessorJob --hostname "$${HOSTNAME}"']
      interval: 30s
      timeout: 60s
      retries: 5
      start_period: 120s

  airflow-triggerer:
    healthcheck:
      test: ["CMD-SHELL", 'airflow jobs check --job-type TriggererJob --hostname "$${HOSTNAME}"']
      interval: 30s
      timeout: 60s
      retries: 5
      start_period: 120s
