services:
  # Build a custom Airflow image with duckdb/dbt/GX baked in so DAG parsing
  # doesn't rely on runtime pip installs.
  airflow-apiserver:
    build: .
    image: tfl-airflow-with-deps:3.1.2
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
      PIP_CONSTRAINT: "https://raw.githubusercontent.com/apache/airflow/constraints-3.1.2/constraints-3.11.txt"
      AIRFLOW__CORE__AUTH_MANAGER: "airflow.api_fastapi.auth.managers.simple.simple_auth_manager.SimpleAuthManager"
      # Dependencies baked into the image; keep runtime installs disabled.
      _PIP_ADDITIONAL_REQUIREMENTS: ""
    command: api-server
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-scheduler:
    build: .
    image: tfl-airflow-with-deps:3.1.2
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
      _PIP_ADDITIONAL_REQUIREMENTS: ""
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-worker:
    build: .
    image: tfl-airflow-with-deps:3.1.2
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
      _PIP_ADDITIONAL_REQUIREMENTS: ""
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-dag-processor:
    build: .
    image: tfl-airflow-with-deps:3.1.2
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__OPENLINEAGE__TRANSPORT: '{"type":"http","url":"http://marquez:5000","endpoint":"api/v1/lineage"}'
      AIRFLOW__OPENLINEAGE__NAMESPACE: "tfl-realtime"
      _PIP_ADDITIONAL_REQUIREMENTS: ""
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  airflow-triggerer:
    build: .
    image: tfl-airflow-with-deps:3.1.2
    environment:
      _PIP_ADDITIONAL_REQUIREMENTS: ""
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/requirements.txt:/opt/airflow/requirements.txt
      - ./dbt_project:/opt/airflow/dbt
      - ./data:/opt/airflow/data
    env_file: [.env]

  # Lineage backend + UI
  marquez:
    image: marquezproject/marquez:latest
    ports: ["5050:5000","5051:5001"]
  marquez-web:
    image: marquezproject/marquez-web:latest
    environment: { MARQUEZ_HOST: marquez, MARQUEZ_PORT: "5000" }
    ports: ["3000:3000"]
